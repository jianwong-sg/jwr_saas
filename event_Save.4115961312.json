{
	"type": "EVENT_BUTTON",
	"name": "Save",
	"serverCode": "// code from business-template DocManager\nglobal $dal;\n$tblDocs = $dal->Table(\"doc_files\");\n$tblVers = $dal->Table(\"doc_files_versions\");\n\nif(!is_dir($_SESSION[\"upload_path\"])){\n\t$_SESSION[\"message\"] = \"Upload folder '\".$_SESSION[\"show_upload_path\"].\"' not exist\";\n\t$_SESSION[\"message_style\"] = \"alert-danger\";\n}\nelse{\n\tif( is_array($_SESSION[\"pending_files\"]) ) \n\t{\n\t\tforeach($_SESSION[\"pending_files\"] as $file)\n\t\t{\n\t\t\t$isCatStr = DBLookup(\"select \".AddFieldWrappers(\"isStructure\").\" from \".AddTableWrappers(\"doc_settings\"));\n\t\t\tif($isCatStr){\n\t\t\t\t$p = strrpos($file[\"name\"],\"_\");\n\t\t\t\t$p2 = strrpos($file[\"usrName\"],\".\");\n\t\t\t\t$oldName = substr($file[\"usrName\"],0,$p2);\n\t\t\t\t$oldName = $oldName.substr($file[\"name\"],$p);\n\t\t\t\t$newFName = $file[\"usrName\"];\n\t\t\t\t$newPath = str_replace($oldName,$newFName,$file[\"name\"]);\n\t\t\t\tdocman_rename($file[\"name\"],$newPath);\n\t\t\t\t$file[\"usrName\"] = $newFName;\n\t\t\t\t$file[\"name\"] = $newPath;\n\t\t\t}\n\n\t\t\tif(!file_exists($file[\"name\"])){\n\t\t\t\t\t$_SESSION[\"message\"] = \"File(s) not added\";\n\t\t\t\t\t$_SESSION[\"message_style\"] = \"alert-danger\";\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t$contents = myfile_get_contents($file[\"name\"]);\n\t\t\t$ext = CheckImageExtension($file[\"usrName\"]);\n\t\t\t$thumbfile = \"\";\n\t\t\tif(strtolower($ext) == \".bmp\" || strtolower($ext) == \".gif\" || strtolower($ext) == \".jpeg\" || strtolower($ext) == \".jpg\" || strtolower($ext) == \".png\"){\n\t\t\t\t$thumb = CreateThumbnail($contents, \"70\", $ext);\n\t\t\t\t$p = strrpos($file['name'],\"/\");\n\t\t\t\t$filename = str_replace(substr($file['name'],$p), \"/th_\".substr($file['name'],$p+1),$file['name']);\n\t\t\t\trunner_save_file($filename, $thumb);\n\t\t\t\t$thumbfile = \"th_\".substr($file['name'],$p+1);\n\t\t\t}\n\t\t\t$tblDocs->Value[\"parent_folder_id\"]=$_SESSION[\"current_folder\"];\n\t\t\t$tblDocs->Value[\"file_type\"]=\"file\";\n\t\t\t$tblDocs->Value[\"file\"]=my_json_encode(array($file));\n\t\t\tif($thumbfile)\n\t\t\t\t$tblDocs->Value[\"thumb\"]=$thumbfile;\n\t\t\t$tblDocs->Value[\"hash\"]=generatePassword(HASH_LENGTH);\n\t\t\t$tblDocs->Value[\"name\"]=$file[\"usrName\"];\n\t\t\t$tblDocs->Value[\"ownerid\"]=$_SESSION[\"user_id\"];\n\t\t\t$tblDocs->Value[\"created\"]=now();\n\t\t\t\n\t\t\t$folderSQL = \"select * from \".AddTableWrappers(\"doc_files\").\" where id = \".$_SESSION[\"current_folder\"];\n\t\t\t$folderRs = CustomQuery($folderSQL);\n\t\t\tif($folderData = db_fetch_array($folderRs)){\n\t\t\t\t\t$tblDocs->Value[\"share_ro\"] = $folderData[\"share_ro\"];\n\t\t\t\t\t$tblDocs->Value[\"share_type\"] = $folderData[\"share_type\"];\n\t\t\t\t\t$tblDocs->Value[\"share_users\"] = $folderData[\"share_users\"];\n\t\t\t}\n\n\t\t\t$isCatStr = DBLookup(\"select \".AddFieldWrappers(\"isStructure\").\" from \".AddTableWrappers(\"doc_settings\"));\n\t\t\t$isVersions = DBLookup(\"select \".AddFieldWrappers(\"isVersions\").\" from \".AddTableWrappers(\"doc_settings\"));\n\t\t\tif(!$isCatStr && $isVersions){\n\t\t\t\t$rsfind = DB::Query(\"select * from doc_files where name='\".$file[\"usrName\"].\"' and parent_folder_id=\".$_SESSION[\"current_folder\"]);\n\t\t\t\tif($datafind = $rsfind->fetchAssoc()){\n\t\t\t\t\t$tblVers->Value[\"docid\"] = $datafind[\"id\"];\n\t\t\t\t\t$tblVers->Value[\"file\"] = $datafind[\"file\"];\n\t\t\t\t\t$tblVers->Value[\"ownerid\"] = $_SESSION[\"user_id\"];\n\t\t\t\t\t$tblVers->Value[\"created\"] = $datafind[\"created\"];\n\t\t\t\t\t$tblVers->Add();\n\t\t\t\t\t$tblDocs->Param[\"id\"] = $datafind[\"id\"];\n\t\t\t\t\t$tblDocs->Update();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t$tblDocs->Add();\n\t\t\t}\n\t\t\telse\n\t\t\t\t$tblDocs->Add();\n\t\t\t\t\n\t\t}\n\t\tif(!$_SESSION[\"message\"]){\n\t\t\t$c = count($_SESSION[\"pending_files\"]);\n\t\t\t$_SESSION[\"message\"] = $c.\" file\".addS($c).\" were added\";\n\t\t\t$_SESSION[\"message_style\"] = \"alert-info\";\n\t\t}\n\t}\n}\n\nunset($_SESSION[\"pending_files\"]);\nunset($_SESSION[\"dublArray\"]);\n// end DocManager code\n\n//The code was commented on October 12 2021 14:08 on applying DocManager business template\n\n//global $dal;\n//$tblDocs = $dal->Table(\"doc_files\");\n//\n//if(!is_dir($_SESSION[\"upload_path\"])){\n//\t$_SESSION[\"message\"] = \"Upload folder '\".$_SESSION[\"show_upload_path\"].\"' not exist\";\n//\t$_SESSION[\"message_style\"] = \"alert-danger\";\n//}\n//else{\n//\tif( is_array($_SESSION[\"pending_files\"]) ) \n//\t{\n//\t\tforeach($_SESSION[\"pending_files\"] as $file)\n//\t\t{\n//\t\t\tif(!file_exists($file[\"name\"])){\n//\t\t\t\t\t$_SESSION[\"message\"] = \"File(s) not added\";\n//\t\t\t\t\t$_SESSION[\"message_style\"] = \"alert-danger\";\n//\t\t\t\t\tbreak;\n//\t\t\t}\n//\t\t  $tblDocs->Value[\"parent_folder_id\"]=$_SESSION[\"current_folder\"];\n//\t\t\t$tblDocs->Value[\"file_type\"]=\"file\";\n//\t\t\t$tblDocs->Value[\"file\"]=my_json_encode(array($file));\n//\t\t\t$tblDocs->Value[\"hash\"]=generatePassword(HASH_LENGTH);\n//\t\t\t$tblDocs->Value[\"name\"]=$file[\"usrName\"];\n//\t\t\t$tblDocs->Value[\"ownerid\"]=$_SESSION[\"user_id\"];\n//\t\t\t$tblDocs->Value[\"created\"]=now();\n//\t\t\t\n//\t\t\t$folderSQL = \"select * from \".AddTableWrappers(\"doc_files\").\" where id = \".$_SESSION[\"current_folder\"];\n//\t\t\t$folderRs = CustomQuery($folderSQL);\n//\t\t\tif($folderData = db_fetch_array($folderRs)){\n//\t\t\t\t\t$tblDocs->Value[\"share_ro\"] = $folderData[\"share_ro\"];\n//\t\t\t\t\t$tblDocs->Value[\"share_type\"] = $folderData[\"share_type\"];\n//\t\t\t\t\t$tblDocs->Value[\"share_users\"] = $folderData[\"share_users\"];\n//\t\t\t}\n//\t\t\t$tblDocs->Add();\n//\t\t}\n//\t\tif(!$_SESSION[\"message\"]){\n//\t\t\t$c = count($_SESSION[\"pending_files\"]);\n//\t\t\t$_SESSION[\"message\"] = $c.\" file\".addS($c).\" were added\";\n//\t\t\t$_SESSION[\"message_style\"] = \"alert-info\";\n//\t\t}\n//\t}\n//}\n//\n//unset($_SESSION[\"pending_files\"]);\n//",
	"beforeJsCode": "// code from business-template DocManager\nif ( Runner._dropzone && (!Runner._dropzone.files || !Runner._dropzone.files.length) ) {\n\t$('#docman-dropzone').hide();\n\t$('[id^=Save_]').hide();\n\t$('[id^=Cancel_]').hide();\n\t$.post(\"doc_files_list.php\", {\n\t}) \n}\nvar checkDublicate = function(param){\n\t$.get(\"doc_files_list.php\",{\n\t\ta: \"checkdublicate\",\n\t\tlink: param\n\t})\n\t.done(function(res){\n\t\tif(res){\n\t\t\tout = JSON.parse(res);\n\t\t\tclient_w=document.body.clientWidth;\n\t\t\tclient_h=document.body.clientHeight;\n\t\t\tvar path = out[\"name\"];\n\t\t\tvar p = out[\"name\"].lastIndexOf(\"_\");\n\t\t\tpath = out[\"name\"].substr(0,p)+out[\"name\"].substr(p+9);\n\t\t\t$(\"#popupfname\").html(\"...\"+path.substr(-47));\n\t\t\t$(\"#popupnewfname\").html(out[\"newName\"]);\n\t\t\t$(\"#renamefile\").css(\"left\",(client_w/2-175)+\"px\");\n\t\t\t$(\"#renamefile\").css(\"top\",(client_h/2-100)+\"px\");\n\t\t\t$(\"#renamefile\").show();\n\t\t\t$(\"#popupskip\").bind(\"click\", function(){\n\t\t\t\tcheckDublicate(\"cancel\");\n\t\t\t\treturn false;\n\t\t\t});\n\t\t\t$(\"#popupreplace\").bind(\"click\", function(){\n\t\t\t\tcheckDublicate(\"replace\");\n\t\t\t\treturn false;\n\t\t\t});\n\t\t\t$(\"#popupnewname\").bind(\"click\", function(){\n\t\t\t\tcheckDublicate(\"newname\");\n\t\t\t\treturn false;\n\t\t\t});\n\n\t\t\treturn false;\n\t\t}\n\t\tajax.submit();\n\t});\n}\n\ncheckDublicate(\"\");\n\nreturn false;\n\n// end DocManager code\n\n//The code was commented on October 12 2021 14:08 on applying DocManager business template\n\n//\n//\tif ( Runner._dropzone && (!Runner._dropzone.files || !Runner._dropzone.files.length) ) {\n//\t\t$('#docman-dropzone').hide();\n//\t}\n//",
	"afterJsCode": "// code from business-template DocManager\nvar currentLocation = location.href;\nif(currentLocation.indexOf(\"rand=\")!=-1){\n\tvar p = currentLocation.indexOf(\"rand=\");\n\tcurrentLocation = currentLocation.substr(0,p-1);\n}\nif(currentLocation.indexOf(\"?\")!=-1)\n\tcurrentLocation+=\"&rand=\"+Math.random();\nelse\n\tcurrentLocation+=\"?rand=\"+Math.random();\n\nlocation.href = currentLocation;\n\n// end DocManager code\n\n//The code was commented on October 12 2021 14:08 on applying DocManager business template\n\n//\n//location.reload();"
}